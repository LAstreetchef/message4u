<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SecretMessage4U Widget Test</title>
  <style>
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 20px;
      background: #f5f5f7;
      color: #1a1a2e;
    }
    
    h1 {
      text-align: center;
      margin-bottom: 8px;
    }
    
    .subtitle {
      text-align: center;
      color: #6b6b80;
      margin-bottom: 40px;
    }
    
    .test-section {
      max-width: 800px;
      margin: 0 auto 40px;
      background: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .test-section h2 {
      margin-top: 0;
      padding-bottom: 12px;
      border-bottom: 1px solid #e1e1e6;
    }
    
    .test-section h3 {
      color: #6b6b80;
      font-size: 0.875rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 8px;
    }
    
    pre {
      background: #f5f5f7;
      padding: 16px;
      border-radius: 8px;
      overflow-x: auto;
      font-size: 0.875rem;
      margin-bottom: 20px;
    }
    
    code {
      font-family: 'SF Mono', Monaco, Consolas, monospace;
    }
    
    .widget-container {
      min-height: 400px;
      border: 2px dashed #e1e1e6;
      border-radius: 12px;
      padding: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .trigger-btn {
      padding: 14px 28px;
      background: #7c5cfc;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .trigger-btn:hover {
      background: #6b4ce0;
    }
    
    .config-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }
    
    .config-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    
    .config-item label {
      font-size: 0.875rem;
      font-weight: 500;
      color: #6b6b80;
    }
    
    .config-item input,
    .config-item select {
      padding: 10px 12px;
      border: 1px solid #e1e1e6;
      border-radius: 6px;
      font-size: 1rem;
    }
    
    .apply-btn {
      padding: 12px 24px;
      background: #1a1a2e;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 1rem;
      cursor: pointer;
    }
    
    .apply-btn:hover {
      background: #2a2a3e;
    }
    
    .events-log {
      background: #1a1a2e;
      color: #38a169;
      padding: 16px;
      border-radius: 8px;
      font-family: 'SF Mono', Monaco, Consolas, monospace;
      font-size: 0.875rem;
      min-height: 100px;
      max-height: 200px;
      overflow-y: auto;
    }
    
    .events-log .event {
      margin-bottom: 4px;
    }
    
    .events-log .event-time {
      color: #6b6b80;
    }
    
    .dark-mode {
      background: #1a1a2e !important;
    }
    
    .dark-mode .widget-container {
      border-color: #3a3a4e;
    }
  </style>
</head>
<body>
  <h1>üîê SecretMessage4U Widget Test</h1>
  <p class="subtitle">Test the embeddable widget in different modes and configurations</p>
  
  <!-- Test 1: Inline Mode -->
  <div class="test-section">
    <h2>1. Inline Mode</h2>
    <p>The widget renders directly into a container element.</p>
    
    <h3>Embed Code</h3>
    <pre><code>&lt;script
  src="https://secretmessage4u.com/widget/v1/sm-widget.js"
  data-partner-id="test_partner_123"
  data-mode="inline"
  data-target="#secret-message-widget"
&gt;&lt;/script&gt;
&lt;div id="secret-message-widget"&gt;&lt;/div&gt;</code></pre>
    
    <h3>Live Preview</h3>
    <div class="widget-container">
      <div id="inline-widget-container"></div>
    </div>
  </div>
  
  <!-- Test 2: Modal Mode -->
  <div class="test-section">
    <h2>2. Modal Mode</h2>
    <p>The widget opens in a modal when a trigger button is clicked.</p>
    
    <h3>Embed Code</h3>
    <pre><code>&lt;script
  src="https://secretmessage4u.com/widget/v1/sm-widget.js"
  data-partner-id="test_partner_123"
  data-mode="modal"
  data-trigger="#send-secret-btn"
&gt;&lt;/script&gt;
&lt;button id="send-secret-btn"&gt;Send a Secret Message&lt;/button&gt;</code></pre>
    
    <h3>Live Preview</h3>
    <div class="widget-container">
      <button class="trigger-btn" id="modal-trigger-btn">
        Send a Secret Message
      </button>
    </div>
    <div id="modal-widget-container"></div>
  </div>
  
  <!-- Test 3: Programmatic API -->
  <div class="test-section">
    <h2>3. Programmatic API with Callbacks</h2>
    <p>Full control over the widget with JavaScript.</p>
    
    <h3>Code</h3>
    <pre><code>const widget = SecretMessageWidget.init({
  partnerId: 'test_partner_123',
  mode: 'inline',
  target: '#my-widget',
  theme: {
    accent: '#e53e3e',
    title: 'Custom Title'
  },
  callbacks: {
    onReady: () => console.log('Widget ready!'),
    onMessageCreated: (data) => console.log('Message created:', data),
    onError: (error) => console.log('Error:', error)
  }
});</code></pre>
    
    <h3>Events Log</h3>
    <div class="events-log" id="events-log">
      <div class="event"><span class="event-time">[--:--:--]</span> Waiting for events...</div>
    </div>
  </div>
  
  <!-- Test 4: Custom Theme -->
  <div class="test-section">
    <h2>4. Custom Theme</h2>
    <p>Customize colors, text, and styling.</p>
    
    <h3>Configuration</h3>
    <div class="config-grid">
      <div class="config-item">
        <label>Accent Color</label>
        <input type="color" id="config-accent" value="#7c5cfc">
      </div>
      <div class="config-item">
        <label>Background</label>
        <input type="color" id="config-bg" value="#ffffff">
      </div>
      <div class="config-item">
        <label>Text Color</label>
        <input type="color" id="config-text" value="#1a1a2e">
      </div>
      <div class="config-item">
        <label>Border Radius (px)</label>
        <input type="number" id="config-radius" value="12" min="0" max="24">
      </div>
      <div class="config-item">
        <label>Title</label>
        <input type="text" id="config-title" value="Send a Secret">
      </div>
      <div class="config-item">
        <label>Button Text</label>
        <input type="text" id="config-btn" value="Send It!">
      </div>
      <div class="config-item">
        <label>Price ($)</label>
        <input type="number" id="config-price" value="2.99" min="0.99" max="99.99" step="0.01">
      </div>
    </div>
    <button class="apply-btn" id="apply-theme-btn">Apply Theme</button>
    
    <h3>Preview</h3>
    <div class="widget-container" id="custom-widget-wrapper">
      <div id="custom-widget-container"></div>
    </div>
  </div>
  
  <!-- Test 5: Dark Mode -->
  <div class="test-section">
    <h2>5. Dark Mode Theme</h2>
    <p>Widget with dark background and light text.</p>
    
    <div class="widget-container dark-mode">
      <div id="dark-widget-container"></div>
    </div>
  </div>
  
  <!-- Mock API for testing -->
  <script>
    // Mock the API responses for local testing
    const MOCK_PARTNER_CONFIG = {
      partner_id: 'test_partner_123',
      theme: {
        accent: '#7c5cfc',
        background: '#ffffff',
        text_color: '#1a1a2e',
        radius: 12,
        title: 'Send a Secret Message',
        subtitle: 'Only the recipient can unlock it',
        btn_text: 'Send Secret Message',
        footer: 'Powered by SecretMessage4U'
      },
      pricing: {
        default_price: 2.99,
        allow_custom_price: false,
        min_price: 0.99,
        max_price: 99.99
      },
      content_flag: 'standard',
      status: 'active'
    };
    
    let messageCounter = 0;
    
    // Intercept fetch for local testing
    const originalFetch = window.fetch;
    window.fetch = function(url, options) {
      // Mock partner config endpoint
      if (url.includes('/v1/partners/') && url.includes('/widget-config')) {
        return Promise.resolve({
          ok: true,
          json: () => Promise.resolve(MOCK_PARTNER_CONFIG)
        });
      }
      
      // Mock message creation endpoint
      if (url.includes('/v1/messages') && options?.method === 'POST') {
        messageCounter++;
        const msgId = 'msg_test_' + messageCounter + '_' + Date.now().toString(36);
        return Promise.resolve({
          ok: true,
          json: () => Promise.resolve({
            id: msgId,
            unlock_url: 'https://secretmessage4u.com/m/' + msgId,
            status: 'awaiting_payment',
            price: JSON.parse(options.body).price || 2.99,
            created_at: new Date().toISOString()
          })
        });
      }
      
      // Pass through other requests
      return originalFetch.apply(this, arguments);
    };
  </script>
  
  <!-- Load the widget -->
  <script src="./sm-widget.js"></script>
  
  <!-- Initialize test widgets -->
  <script>
    // Events log helper
    function logEvent(message) {
      const log = document.getElementById('events-log');
      const time = new Date().toLocaleTimeString();
      const event = document.createElement('div');
      event.className = 'event';
      event.innerHTML = `<span class="event-time">[${time}]</span> ${message}`;
      log.appendChild(event);
      log.scrollTop = log.scrollHeight;
    }
    
    // Wait for widget script to load
    window.addEventListener('load', function() {
      // 1. Inline Mode Widget
      SecretMessageWidget.init({
        partnerId: 'test_partner_123',
        mode: 'inline',
        target: '#inline-widget-container'
      });
      
      // 2. Modal Mode Widget
      SecretMessageWidget.init({
        partnerId: 'test_partner_123',
        mode: 'modal',
        target: '#modal-widget-container',
        trigger: '#modal-trigger-btn',
        callbacks: {
          onModalOpen: () => logEvent('Modal opened'),
          onModalClose: () => logEvent('Modal closed')
        }
      });
      
      // 3. Programmatic Widget with Callbacks
      // (Just logging events, no separate widget for this section)
      logEvent('Widget SDK loaded and ready');
      
      // 4. Custom Theme Widget (will be initialized on apply)
      let customWidget = null;
      
      document.getElementById('apply-theme-btn').addEventListener('click', function() {
        // Destroy existing widget
        if (customWidget) {
          customWidget.destroy();
        }
        
        // Get config values
        const accent = document.getElementById('config-accent').value;
        const bg = document.getElementById('config-bg').value;
        const textColor = document.getElementById('config-text').value;
        const radius = parseInt(document.getElementById('config-radius').value) || 12;
        const title = document.getElementById('config-title').value;
        const btnText = document.getElementById('config-btn').value;
        const price = parseFloat(document.getElementById('config-price').value) || 2.99;
        
        // Update container background if dark
        const wrapper = document.getElementById('custom-widget-wrapper');
        const luminance = getLuminance(bg);
        if (luminance < 0.5) {
          wrapper.classList.add('dark-mode');
        } else {
          wrapper.classList.remove('dark-mode');
        }
        
        // Create new widget
        customWidget = SecretMessageWidget.init({
          partnerId: 'test_partner_123',
          mode: 'inline',
          target: '#custom-widget-container',
          accent: accent,
          bg: bg,
          textColor: textColor,
          radius: radius,
          title: title,
          btnText: btnText,
          price: price,
          callbacks: {
            onReady: () => logEvent('Custom theme widget ready'),
            onMessageCreated: (data) => logEvent('Message created: ' + data.unlock_url),
            onError: (err) => logEvent('Error: ' + err.message)
          }
        });
        
        logEvent('Applied custom theme: accent=' + accent);
      });
      
      // Initialize custom widget with defaults
      document.getElementById('apply-theme-btn').click();
      
      // 5. Dark Mode Widget
      SecretMessageWidget.init({
        partnerId: 'test_partner_123',
        mode: 'inline',
        target: '#dark-widget-container',
        accent: '#38a169',
        bg: '#1a1a2e',
        textColor: '#ffffff',
        title: 'Dark Mode Secret',
        subtitle: 'Looks great on dark backgrounds',
        callbacks: {
          onReady: () => logEvent('Dark mode widget ready'),
          onMessageCreated: (data) => logEvent('Dark widget message: ' + data.id)
        }
      });
    });
    
    // Helper to calculate luminance
    function getLuminance(hex) {
      const rgb = hex.match(/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i);
      if (!rgb) return 1;
      const r = parseInt(rgb[1], 16) / 255;
      const g = parseInt(rgb[2], 16) / 255;
      const b = parseInt(rgb[3], 16) / 255;
      return 0.299 * r + 0.587 * g + 0.114 * b;
    }
  </script>
</body>
</html>
